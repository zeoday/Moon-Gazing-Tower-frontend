import { useParams, Link } from 'react-router-dom'
import { useQuery } from '@tanstack/react-query'
import { vulnApi } from '@/api/vulnerabilities'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { cn, formatDate, getSeverityColor, getStatusColor } from '@/lib/utils'
import { ArrowLeft, ExternalLink } from 'lucide-react'

export default function VulnerabilityDetailPage() {
  const { id } = useParams<{ id: string }>()

  const { data, isLoading } = useQuery({
    queryKey: ['vulnerability', id],
    queryFn: () => vulnApi.getVulnerability(id!),
    enabled: !!id,
  })

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      </div>
    )
  }

  const vuln = data?.data

  if (!vuln) {
    return (
      <div className="text-center py-8">
        <p className="text-muted-foreground">漏洞不存在</p>
        <Button asChild className="mt-4">
          <Link to="/vulnerabilities">返回列表</Link>
        </Button>
      </div>
    )
  }

  const getSeverityLabel = (severity: string) => {
    const labels: Record<string, string> = {
      critical: '严重',
      high: '高危',
      medium: '中危',
      low: '低危',
      info: '信息',
    }
    return labels[severity] || severity
  }

  const getStatusLabel = (status: string) => {
    const labels: Record<string, string> = {
      open: '待处理',
      confirmed: '已确认',
      fixed: '已修复',
      ignored: '已忽略',
      false_positive: '误报',
    }
    return labels[status] || status
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" asChild>
          <Link to="/vulnerabilities">
            <ArrowLeft className="h-5 w-5" />
          </Link>
        </Button>
        <div className="flex-1">
          <h1 className="text-2xl font-bold">{vuln.name}</h1>
          <div className="flex items-center gap-2 mt-1">
            <Badge className={cn(getSeverityColor(vuln.severity))}>
              {getSeverityLabel(vuln.severity)}
            </Badge>
            <Badge variant="outline" className={cn(getStatusColor(vuln.status))}>
              {getStatusLabel(vuln.status)}
            </Badge>
            {vuln.cve && (
              <Badge variant="secondary">{vuln.cve}</Badge>
            )}
          </div>
        </div>
      </div>

      <div className="grid gap-6 md:grid-cols-2">
        <Card>
          <CardHeader>
            <CardTitle>基本信息</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-muted-foreground">漏洞类型</p>
                <p className="font-medium">{vuln.type}</p>
              </div>
              <div>
                <p className="text-sm text-muted-foreground">CVE编号</p>
                <p className="font-medium">{vuln.cve || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-muted-foreground">CWE编号</p>
                <p className="font-medium">{vuln.cwe || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-muted-foreground">发现时间</p>
                <p className="font-medium">{formatDate(vuln.createdAt)}</p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>目标信息</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <p className="text-sm text-muted-foreground">资产名称</p>
              <p className="font-medium">{vuln.assetName}</p>
            </div>
            <div>
              <p className="text-sm text-muted-foreground">目标地址</p>
              <p className="font-medium font-mono">{vuln.target}</p>
            </div>
            {vuln.url && (
              <div>
                <p className="text-sm text-muted-foreground">URL</p>
                <p className="font-medium font-mono text-sm break-all">{vuln.url}</p>
              </div>
            )}
            {vuln.parameter && (
              <div>
                <p className="text-sm text-muted-foreground">参数</p>
                <p className="font-medium font-mono">{vuln.parameter}</p>
              </div>
            )}
          </CardContent>
        </Card>

        {vuln.description && (
          <Card className="md:col-span-2">
            <CardHeader>
              <CardTitle>漏洞描述</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-sm whitespace-pre-wrap">{vuln.description}</p>
            </CardContent>
          </Card>
        )}

        {vuln.payload && (
          <Card className="md:col-span-2">
            <CardHeader>
              <CardTitle>Payload</CardTitle>
            </CardHeader>
            <CardContent>
              <pre className="bg-muted p-4 rounded-lg text-sm overflow-auto font-mono">
                {vuln.payload}
              </pre>
            </CardContent>
          </Card>
        )}

        {vuln.evidence && (
          <Card className="md:col-span-2">
            <CardHeader>
              <CardTitle>证据</CardTitle>
            </CardHeader>
            <CardContent>
              <pre className="bg-muted p-4 rounded-lg text-sm overflow-auto font-mono max-h-96">
                {vuln.evidence}
              </pre>
            </CardContent>
          </Card>
        )}

        {vuln.solution && (
          <Card className="md:col-span-2">
            <CardHeader>
              <CardTitle>修复建议</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-sm whitespace-pre-wrap">{vuln.solution}</p>
            </CardContent>
          </Card>
        )}

        {vuln.references && vuln.references.length > 0 && (
          <Card className="md:col-span-2">
            <CardHeader>
              <CardTitle>参考链接</CardTitle>
            </CardHeader>
            <CardContent>
              <ul className="space-y-2">
                {vuln.references.map((ref, index) => (
                  <li key={index}>
                    <a
                      href={ref}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-primary hover:underline flex items-center gap-1"
                    >
                      {ref}
                      <ExternalLink className="h-3 w-3" />
                    </a>
                  </li>
                ))}
              </ul>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  )
}
